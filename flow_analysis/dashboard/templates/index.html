<!DOCTYPE html>
<html>
<head>
    <title>Collector Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            margin-bottom: 20px;
        }
        .status-running { background-color: #d4edda; }
        .status-delayed { background-color: #fff3cd; }
        .status-stalled { background-color: #f8d7da; }
        .status-error { background-color: #f8d7da; }
        .status-no-data { background-color: #e2e3e5; }
        .status-waiting { background-color: #cce5ff; }
        .status-unknown { background-color: #f8f9fa; }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
        }
        .log-error { background-color: #f8d7da; }
        .log-warning { background-color: #fff3cd; }
        .log-info { background-color: #d1ecf1; }
        
        .heartbeat-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .heartbeat-active { background-color: #28a745; }
        .heartbeat-stale { background-color: #dc3545; }
        
        .status-badge {
            font-size: 0.9em;
            padding: 0.4em 0.6em;
        }
        
        .error-details {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Collector Dashboard</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System Health</h5>
                        <p class="card-text">
                            Overall Status: 
                            <span class="badge {% if health.overall_status == 'healthy' %}bg-success
                                             {% elif health.overall_status == 'degraded' %}bg-warning
                                             {% else %}bg-danger{% endif %}">
                                {{ health.overall_status }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            {% for collector_type, status in health.collectors.items() %}
            <div class="col-md-6">
                <div class="card status-card status-{{ status.status }}" data-collector="{{ collector_type }}">
                    <div class="card-body">
                        <h5 class="card-title">
                            {{ collector_type.title() }} Collector
                            <span class="heartbeat-indicator {% if status.status in ['running', 'delayed', 'waiting_for_market_open'] %}heartbeat-active{% else %}heartbeat-stale{% endif %}" 
                                  title="Status: {{ status.status }}&#10;Last seen: {{ status.last_update }}"></span>
                            <span class="last-seen-badge badge"
                                  style="vertical-align: middle; margin-left: 5px;"
                                  data-last-update="{{ status.last_update }}">
                                <!-- Will be filled by JS -->
                            </span>
                        </h5>
                        <p class="card-text">
                            Status: 
                            <span class="badge status-badge {% if status.status == 'running' %}bg-success
                                                          {% elif status.status == 'delayed' %}bg-warning
                                                          {% elif status.status == 'waiting_for_market_open' %}bg-info
                                                          {% else %}bg-danger{% endif %}">
                                {{ status.status }}
                            </span>
                        </p>
                        <p class="card-text">
                            Last Update: <span class="last-update">{{ status.last_update }}</span>
                        </p>
                        <p class="card-text">
                            <small class="text-muted status-message">{{ status.message }}</small>
                        </p>
                        {% if status.error_details %}
                        <div class="error-details">
                            <strong>Error Details:</strong>
                            <pre>{{ status.error_details | tojson(indent=2) }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Data Freshness & Completeness Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Data Freshness & Completeness</h5>
                        <div id="dataFreshnessContainer">
                            <!-- Data freshness will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Counts Chart Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Hourly Collection Counts (Last 24h)</h5>
                        <canvas id="collectionCountsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Data Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Export Data</h5>
                        <form id="exportForm" class="row g-3 align-items-end">
                            <div class="col-auto">
                                <label class="form-label mb-0">Collectors:</label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="collectors" value="news" id="collectorNews" checked>
                                    <label class="form-check-label" for="collectorNews">News</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="collectors" value="darkpool" id="collectorDarkpool" checked>
                                    <label class="form-check-label" for="collectorDarkpool">Darkpool</label>
                                </div>
                            </div>
                            <div class="col-auto">
                                <label for="startTime" class="form-label mb-0">Start Time:</label>
                                <input type="datetime-local" class="form-control" id="startTime" name="start_time">
                            </div>
                            <div class="col-auto">
                                <label for="endTime" class="form-label mb-0">End Time:</label>
                                <input type="datetime-local" class="form-control" id="endTime" name="end_time">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary">Export</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Status History</h5>
                        <div class="d-flex align-items-center mb-2">
                            <label for="historyRange" class="form-label mb-0 me-2">Time Range:</label>
                            <select id="historyRange" class="form-select form-select-sm w-auto">
                                <option value="6">Last 6h</option>
                                <option value="12">Last 12h</option>
                                <option value="24" selected>Last 24h</option>
                            </select>
                            <div id="statusLegend" class="ms-4"></div>
                        </div>
                        <canvas id="statusChart"></canvas>
                        <div class="mt-3">
                            <h6>Status History Table</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="statusHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>Collector</th>
                                            <th>Timestamp</th>
                                            <th>Status</th>
                                            <th>Message</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Logs</h5>
                        <div id="logContainer">
                            <!-- Logs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Status colors for the chart
        const statusColors = {
            'running': '#28a745',
            'delayed': '#ffc107',
            'stalled': '#dc3545',
            'error': '#dc3545',
            'no_data': '#6c757d',
            'waiting_for_market_open': '#17a2b8',
            'unknown': '#f8f9fa'
        };

        // Helper to format "Last Seen" badge
        function formatLastSeenBadge(lastUpdate) {
            if (!lastUpdate) return {text: 'Never', color: 'bg-secondary'};
            const now = new Date();
            const last = new Date(lastUpdate);
            const diffSec = Math.floor((now - last) / 1000);
            let text = '';
            let color = '';
            if (diffSec < 60) {
                text = 'Just now';
                color = 'bg-success';
            } else if (diffSec < 300) {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-success';
            } else if (diffSec < 1800) {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-warning';
            } else {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-danger';
            }
            return {text, color};
        }

        // Fetch and update status every 30 seconds
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update status cards
                    Object.entries(data.collectors).forEach(([collector, status]) => {
                        const card = document.querySelector(`[data-collector="${collector}"]`);
                        if (card) {
                            card.className = `card status-card status-${status.status}`;
                            card.querySelector('.status-badge').textContent = status.status;
                            card.querySelector('.last-update').textContent = status.last_update;
                            card.querySelector('.status-message').textContent = status.message;
                            
                            // Update heartbeat indicator and tooltip
                            const indicator = card.querySelector('.heartbeat-indicator');
                            indicator.className = `heartbeat-indicator ${
                                status.status in ['running', 'delayed', 'waiting_for_market_open'] 
                                ? 'heartbeat-active' 
                                : 'heartbeat-stale'
                            }`;
                            indicator.title = `Status: ${status.status}\nLast seen: ${status.last_update}`;

                            // Update Last Seen badge
                            const lastSeenBadge = card.querySelector('.last-seen-badge');
                            const badgeInfo = formatLastSeenBadge(status.last_update);
                            lastSeenBadge.textContent = badgeInfo.text;
                            lastSeenBadge.className = `last-seen-badge badge ${badgeInfo.color}`;
                            lastSeenBadge.setAttribute('data-last-update', status.last_update);
                            
                            // Update error details if present
                            const errorDiv = card.querySelector('.error-details');
                            if (status.error_details) {
                                if (!errorDiv) {
                                    const newErrorDiv = document.createElement('div');
                                    newErrorDiv.className = 'error-details';
                                    newErrorDiv.innerHTML = `
                                        <strong>Error Details:</strong>
                                        <pre>${JSON.stringify(status.error_details, null, 2)}</pre>
                                    `;
                                    card.querySelector('.card-body').appendChild(newErrorDiv);
                                } else {
                                    errorDiv.querySelector('pre').textContent = 
                                        JSON.stringify(status.error_details, null, 2);
                                }
                            } else if (errorDiv) {
                                errorDiv.remove();
                            }
                        }
                    });
                });
        }

        // Render legend for status colors
        function renderStatusLegend() {
            const legend = document.getElementById('statusLegend');
            legend.innerHTML = Object.entries(statusColors).map(([status, color]) =>
                `<span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:2px;margin-right:4px;"></span> ${status}`
            ).join(' &nbsp; ');
        }
        renderStatusLegend();

        // Fetch and update history chart and table
        function updateHistory() {
            const hours = document.getElementById('historyRange').value;
            fetch(`/api/history?hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('statusChart').getContext('2d');
                    // Prepare data for each collector
                    const datasets = Object.entries(data).map(([collector, history]) => {
                        return {
                            label: collector,
                            data: history.map(h => ({
                                x: new Date(h.timestamp),
                                y: h.status,
                                details: h
                            })),
                            borderColor: statusColors[history[0]?.status] || '#6c757d',
                            backgroundColor: statusColors[history[0]?.status] || '#6c757d',
                            stepped: true,
                            showLine: true,
                            fill: false,
                            tension: 0
                        };
                    });
                    // Y-axis labels
                    const statusLabels = Object.keys(statusColors);
                    // Update or create chart
                    if (window.statusChart) {
                        window.statusChart.data.datasets = datasets;
                        window.statusChart.options.scales.y.labels = statusLabels;
                        window.statusChart.update();
                    } else {
                        window.statusChart = new Chart(ctx, {
                            type: 'line',
                            data: { datasets },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'top' },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const details = context.raw.details;
                                                return [
                                                    `Status: ${details.status}`,
                                                    `Message: ${details.message}`,
                                                    `Time: ${new Date(details.timestamp).toLocaleString()}`
                                                ];
                                            }
                                        }
                                    },
                                    title: { display: false }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: 'hour' },
                                        title: { display: true, text: 'Time' }
                                    },
                                    y: {
                                        type: 'category',
                                        labels: statusLabels,
                                        title: { display: true, text: 'Status' }
                                    }
                                }
                            }
                        });
                    }
                    // Update table view
                    const tbody = document.querySelector('#statusHistoryTable tbody');
                    let rows = [];
                    Object.entries(data).forEach(([collector, history]) => {
                        history.forEach(h => {
                            rows.push({
                                collector,
                                timestamp: new Date(h.timestamp).toLocaleString(),
                                status: h.status,
                                message: h.message
                            });
                        });
                    });
                    // Sort by timestamp descending
                    rows.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    tbody.innerHTML = rows.map(row =>
                        `<tr>
                            <td>${row.collector}</td>
                            <td>${row.timestamp}</td>
                            <td><span class="badge" style="background:${statusColors[row.status] || '#6c757d'};color:#fff;">${row.status}</span></td>
                            <td>${row.message || ''}</td>
                        </tr>`
                    ).join('');
                });
        }
        // Time range selector event
        if (document.getElementById('historyRange')) {
            document.getElementById('historyRange').addEventListener('change', updateHistory);
        }

        // Fetch and update logs
        function updateLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('logContainer');
                    container.innerHTML = data.map(log => `
                        <div class="log-entry log-${log.level.toLowerCase()}">
                            <strong>${new Date(log.timestamp).toLocaleString()}</strong>
                            <span class="badge bg-${log.level === 'ERROR' ? 'danger' : 
                                                   log.level === 'WARNING' ? 'warning' : 
                                                   'info'}">${log.level}</span>
                            <span>${log.message}</span>
                            ${log.details ? `<pre>${JSON.stringify(log.details, null, 2)}</pre>` : ''}
                        </div>
                    `).join('');
                });
        }

        // Fetch and update data freshness
        function updateDataFreshness() {
            fetch('/api/data_freshness')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('dataFreshnessContainer');
                    let html = '<table class="table table-bordered table-sm"><thead><tr>' +
                        '<th>Collector</th>' +
                        '<th>Last Data Timestamp</th>' +
                        '<th>Items Collected (Last Hour)</th>' +
                        '<th>Expected Items</th>' +
                        '<th>Completeness (%)</th>' +
                        '<th>Status</th>' +
                        '</tr></thead><tbody>';
                    Object.entries(data).forEach(([collector, info]) => {
                        html += `<tr>
                            <td>${collector.charAt(0).toUpperCase() + collector.slice(1)}</td>
                            <td>${info.last_data_timestamp ? new Date(info.last_data_timestamp).toLocaleString() : 'N/A'}</td>
                            <td>${info.items_collected}</td>
                            <td>${info.expected_items}</td>
                            <td>${info.completeness}%</td>
                            <td><span class="badge bg-${info.status === 'up_to_date' ? 'success' : 'danger'}">${info.status.replace('_', ' ')}</span></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                });
        }

        // Fetch and update collection counts chart
        function updateCollectionCountsChart() {
            fetch('/api/collection_counts')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('collectionCountsChart').getContext('2d');
                    // Get all unique hourly intervals
                    const allIntervals = Array.from(new Set([
                        ...data.news.map(d => d.interval),
                        ...data.darkpool.map(d => d.interval)
                    ])).sort();
                    // Map counts to intervals (fill missing with 0)
                    const newsCounts = allIntervals.map(interval => {
                        const found = data.news.find(d => d.interval === interval);
                        return found ? found.count : 0;
                    });
                    const darkpoolCounts = allIntervals.map(interval => {
                        const found = data.darkpool.find(d => d.interval === interval);
                        return found ? found.count : 0;
                    });
                    // Prepare chart data
                    const chartData = {
                        labels: allIntervals.map(i => new Date(i).toLocaleString()),
                        datasets: [
                            {
                                label: 'News Collector',
                                data: newsCounts,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.2)',
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: 'Darkpool Collector',
                                data: darkpoolCounts,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.2)',
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    };
                    // Create or update chart
                    if (window.collectionCountsChart) {
                        window.collectionCountsChart.data = chartData;
                        window.collectionCountsChart.update();
                    } else {
                        window.collectionCountsChart = new Chart(ctx, {
                            type: 'line',
                            data: chartData,
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'top' },
                                    title: { display: false }
                                },
                                scales: {
                                    x: { title: { display: true, text: 'Hour' } },
                                    y: { title: { display: true, text: 'Items Collected' }, beginAtZero: true }
                                }
                            }
                        });
                    }
                });
        }

        // Export form handler
        document.getElementById('exportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const collectors = Array.from(form.querySelectorAll('input[name="collectors"]:checked')).map(cb => cb.value).join(',');
            const startTime = form.start_time.value ? new Date(form.start_time.value).toISOString() : '';
            const endTime = form.end_time.value ? new Date(form.end_time.value).toISOString() : '';
            let url = `/api/export?collectors=${collectors}`;
            if (startTime) url += `&start_time=${encodeURIComponent(startTime)}`;
            if (endTime) url += `&end_time=${encodeURIComponent(endTime)}`;
            window.open(url, '_blank');
        });

        // Initial load
        updateStatus();
        updateHistory();
        updateLogs();
        updateDataFreshness();
        updateCollectionCountsChart();

        // Set up periodic updates
        setInterval(updateStatus, 30000);  // Every 30 seconds
        setInterval(updateHistory, 300000);  // Every 5 minutes
        setInterval(updateLogs, 60000);  // Every minute
        setInterval(updateDataFreshness, 30000);  // Every 30 seconds
        setInterval(updateCollectionCountsChart, 300000);  // Every 5 minutes
    </script>
</body>
</html> 