<!DOCTYPE html>
<html>
<head>
    <title>Collector Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            margin-bottom: 20px;
        }
        .status-running { background-color: #d4edda; }
        .status-delayed { background-color: #fff3cd; }
        .status-stalled { background-color: #f8d7da; }
        .status-error { background-color: #f8d7da; }
        .status-no-data { background-color: #e2e3e5; }
        .status-waiting { background-color: #cce5ff; }
        .status-unknown { background-color: #f8f9fa; }
        
        .log-entry {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: #fff;
        }
        .log-error { 
            border-left: 4px solid #dc3545;
            background-color: #fff8f8;
        }
        .log-warning { 
            border-left: 4px solid #ffc107;
            background-color: #fffdf8;
        }
        .log-info { 
            border-left: 4px solid #17a2b8;
            background-color: #f8fcfd;
        }
        
        .log-entry pre {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 4px;
        }
        
        .log-entry .badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
        }
        
        .heartbeat-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .heartbeat-active { background-color: #28a745; }
        .heartbeat-stale { background-color: #dc3545; }
        
        .status-badge {
            font-size: 0.9em;
            padding: 0.4em 0.6em;
        }
        
        .error-details {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .manual-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .manual-controls .btn {
            margin-right: 5px;
        }
        
        .backfill-modal .modal-body {
            padding: 20px;
        }
        
        .backfill-modal .form-group {
            margin-bottom: 15px;
        }
        
        .data-freshness-card {
            margin-bottom: 15px;
            border-left: 4px solid transparent;
        }
        .data-freshness-card.fresh {
            border-left-color: #28a745;
        }
        .data-freshness-card.stale {
            border-left-color: #dc3545;
        }
        .data-freshness-card.warning {
            border-left-color: #ffc107;
        }
        
        .completeness-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .completeness-bar-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .completeness-bar-fill.warning {
            background-color: #ffc107;
        }
        .completeness-bar-fill.danger {
            background-color: #dc3545;
        }
        
        .timestamp-tooltip {
            cursor: help;
            border-bottom: 1px dotted #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Collector Dashboard</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System Health</h5>
                        <p class="card-text">
                            Overall Status: 
                            <span class="badge {% if health.overall_status == 'healthy' %}bg-success
                                             {% elif health.overall_status == 'degraded' %}bg-warning
                                             {% else %}bg-danger{% endif %}">
                                {{ health.overall_status }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            {% for collector_type, status in health.collectors.items() %}
            <div class="col-md-6">
                <div class="card status-card status-{{ status.status }}" data-collector="{{ collector_type }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">{{ collector_type.title() }} Collector</h5>
                                <span class="badge status-badge bg-{{ status.status }}">{{ status.status }}</span>
                                <span class="last-seen-badge badge ms-2" data-last-update="{{ status.last_update }}"></span>
                            </div>
                            <div class="heartbeat-indicator" title="Status: {{ status.status }}"></div>
                        </div>
                        <p class="card-text status-message">{{ status.message }}</p>
                        <p class="card-text"><small class="text-muted last-update">Last update: {{ status.last_update }}</small></p>
                        
                        <!-- Manual Controls -->
                        <div class="manual-controls">
                            <button class="btn btn-sm btn-primary" onclick="showBackfillModal('{{ collector_type }}')">
                                <i class="bi bi-arrow-clockwise"></i> Backfill
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="restartCollector('{{ collector_type }}')">
                                <i class="bi bi-arrow-repeat"></i> Restart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Data Freshness & Completeness Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Data Freshness & Completeness</h5>
                        <div id="dataFreshnessContainer">
                            <!-- Data freshness will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Counts Chart Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Hourly Collection Counts (Last 24h)</h5>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary active" data-chart-view="hourly">Hourly</button>
                                <button type="button" class="btn btn-outline-secondary" data-chart-view="daily">Daily</button>
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="collectionCountsChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <small class="text-muted">Total Items Collected (24h)</small>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-primary me-2">News</span>
                                                    <span id="totalNewsCount">-</span>
                                                </div>
                                                <div>
                                                    <span class="badge bg-success me-2">Darkpool</span>
                                                    <span id="totalDarkpoolCount">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <small class="text-muted">Average Items per Hour</small>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-primary me-2">News</span>
                                                    <span id="avgNewsCount">-</span>
                                                </div>
                                                <div>
                                                    <span class="badge bg-success me-2">Darkpool</span>
                                                    <span id="avgDarkpoolCount">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Data Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Export Data</h5>
                        <form id="exportForm" class="row g-3 align-items-end">
                            <div class="col-auto">
                                <label class="form-label mb-0">Collectors:</label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="collectors" value="news" id="collectorNews" checked>
                                    <label class="form-check-label" for="collectorNews">News</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="collectors" value="darkpool" id="collectorDarkpool" checked>
                                    <label class="form-check-label" for="collectorDarkpool">Darkpool</label>
                                </div>
                            </div>
                            <div class="col-auto">
                                <label for="startTime" class="form-label mb-0">Start Time:</label>
                                <input type="datetime-local" class="form-control" id="startTime" name="start_time">
                            </div>
                            <div class="col-auto">
                                <label for="endTime" class="form-label mb-0">End Time:</label>
                                <input type="datetime-local" class="form-control" id="endTime" name="end_time">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary">Export</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Status History</h5>
                        <div class="d-flex align-items-center mb-2">
                            <label for="historyRange" class="form-label mb-0 me-2">Time Range:</label>
                            <select id="historyRange" class="form-select form-select-sm w-auto">
                                <option value="6">Last 6h</option>
                                <option value="12">Last 12h</option>
                                <option value="24" selected>Last 24h</option>
                            </select>
                            <div id="statusLegend" class="ms-4"></div>
                        </div>
                        <canvas id="statusChart"></canvas>
                        <div class="mt-3">
                            <h6>Status History Table</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="statusHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>Collector</th>
                                            <th>Timestamp</th>
                                            <th>Status</th>
                                            <th>Message</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Logs</h5>
                        <div class="mb-3">
                            <div class="row g-3 align-items-end">
                                <div class="col-auto">
                                    <label for="logCollector" class="form-label mb-0">Collector:</label>
                                    <select id="logCollector" class="form-select form-select-sm">
                                        <option value="">All Collectors</option>
                                        <option value="darkpool">Darkpool</option>
                                        <option value="news">News</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label for="logLevel" class="form-label mb-0">Level:</label>
                                    <select id="logLevel" class="form-select form-select-sm">
                                        <option value="">All Levels</option>
                                        <option value="ERROR">Error</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="INFO">Info</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <label for="logHours" class="form-label mb-0">Time Range:</label>
                                    <select id="logHours" class="form-select form-select-sm">
                                        <option value="1">Last Hour</option>
                                        <option value="6">Last 6 Hours</option>
                                        <option value="12">Last 12 Hours</option>
                                        <option value="24">Last 24 Hours</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button id="refreshLogs" class="btn btn-primary btn-sm">Refresh</button>
                                </div>
                            </div>
                        </div>
                        <div id="logContainer" style="max-height: 500px; overflow-y: auto;">
                            <!-- Logs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backfill Modal -->
        <div class="modal fade backfill-modal" id="backfillModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Backfill Data</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="backfillForm">
                            <input type="hidden" id="backfillCollector" name="collector">
                            <div class="form-group">
                                <label for="backfillHours">Hours to Backfill:</label>
                                <input type="number" class="form-control" id="backfillHours" name="hours" value="24" min="1" max="168">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="triggerBackfill()">Start Backfill</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Status colors for the chart
        const statusColors = {
            'running': '#28a745',
            'delayed': '#ffc107',
            'stalled': '#dc3545',
            'error': '#dc3545',
            'no_data': '#6c757d',
            'waiting_for_market_open': '#17a2b8',
            'unknown': '#f8f9fa'
        };

        // Helper to format "Last Seen" badge
        function formatLastSeenBadge(lastUpdate) {
            if (!lastUpdate) return {text: 'Never', color: 'bg-secondary'};
            const now = new Date();
            const last = new Date(lastUpdate);
            const diffSec = Math.floor((now - last) / 1000);
            let text = '';
            let color = '';
            if (diffSec < 60) {
                text = 'Just now';
                color = 'bg-success';
            } else if (diffSec < 300) {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-success';
            } else if (diffSec < 1800) {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-warning';
            } else {
                text = Math.floor(diffSec / 60) + 'm ago';
                color = 'bg-danger';
            }
            return {text, color};
        }

        // Fetch and update status every 30 seconds
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update status cards
                    Object.entries(data.collectors).forEach(([collector, status]) => {
                        const card = document.querySelector(`[data-collector="${collector}"]`);
                        if (card) {
                            card.className = `card status-card status-${status.status}`;
                            card.querySelector('.status-badge').textContent = status.status;
                            card.querySelector('.last-update').textContent = status.last_update;
                            card.querySelector('.status-message').textContent = status.message;
                            
                            // Update heartbeat indicator and tooltip
                            const indicator = card.querySelector('.heartbeat-indicator');
                            indicator.className = `heartbeat-indicator ${
                                status.status in ['running', 'delayed', 'waiting_for_market_open'] 
                                ? 'heartbeat-active' 
                                : 'heartbeat-stale'
                            }`;
                            indicator.title = `Status: ${status.status}\nLast seen: ${status.last_update}`;

                            // Update Last Seen badge
                            const lastSeenBadge = card.querySelector('.last-seen-badge');
                            const badgeInfo = formatLastSeenBadge(status.last_update);
                            lastSeenBadge.textContent = badgeInfo.text;
                            lastSeenBadge.className = `last-seen-badge badge ${badgeInfo.color}`;
                            lastSeenBadge.setAttribute('data-last-update', status.last_update);
                            
                            // Update error details if present
                            const errorDiv = card.querySelector('.error-details');
                            if (status.error_details) {
                                if (!errorDiv) {
                                    const newErrorDiv = document.createElement('div');
                                    newErrorDiv.className = 'error-details';
                                    newErrorDiv.innerHTML = `
                                        <strong>Error Details:</strong>
                                        <pre>${JSON.stringify(status.error_details, null, 2)}</pre>
                                    `;
                                    card.querySelector('.card-body').appendChild(newErrorDiv);
                                } else {
                                    errorDiv.querySelector('pre').textContent = 
                                        JSON.stringify(status.error_details, null, 2);
                                }
                            } else if (errorDiv) {
                                errorDiv.remove();
                            }
                        }
                    });
                });
        }

        // Render legend for status colors
        function renderStatusLegend() {
            const legend = document.getElementById('statusLegend');
            legend.innerHTML = Object.entries(statusColors).map(([status, color]) =>
                `<span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:2px;margin-right:4px;"></span> ${status}`
            ).join(' &nbsp; ');
        }
        renderStatusLegend();

        // Fetch and update history chart and table
        function updateHistory() {
            const hours = document.getElementById('historyRange').value;
            fetch(`/api/history?hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('statusChart').getContext('2d');
                    // Prepare data for each collector
                    const datasets = Object.entries(data).map(([collector, history]) => {
                        return {
                            label: collector,
                            data: history.map(h => ({
                                x: new Date(h.timestamp),
                                y: h.status,
                                details: h
                            })),
                            borderColor: statusColors[history[0]?.status] || '#6c757d',
                            backgroundColor: statusColors[history[0]?.status] || '#6c757d',
                            stepped: true,
                            showLine: true,
                            fill: false,
                            tension: 0
                        };
                    });
                    // Y-axis labels
                    const statusLabels = Object.keys(statusColors);
                    // Update or create chart
                    if (window.statusChart) {
                        window.statusChart.data.datasets = datasets;
                        window.statusChart.options.scales.y.labels = statusLabels;
                        window.statusChart.update();
                    } else {
                        window.statusChart = new Chart(ctx, {
                            type: 'line',
                            data: { datasets },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'top' },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const details = context.raw.details;
                                                return [
                                                    `Status: ${details.status}`,
                                                    `Message: ${details.message}`,
                                                    `Time: ${new Date(details.timestamp).toLocaleString()}`
                                                ];
                                            }
                                        }
                                    },
                                    title: { display: false }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: 'hour' },
                                        title: { display: true, text: 'Time' }
                                    },
                                    y: {
                                        type: 'category',
                                        labels: statusLabels,
                                        title: { display: true, text: 'Status' }
                                    }
                                }
                            }
                        });
                    }
                    // Update table view
                    const tbody = document.querySelector('#statusHistoryTable tbody');
                    let rows = [];
                    Object.entries(data).forEach(([collector, history]) => {
                        history.forEach(h => {
                            rows.push({
                                collector,
                                timestamp: new Date(h.timestamp).toLocaleString(),
                                status: h.status,
                                message: h.message
                            });
                        });
                    });
                    // Sort by timestamp descending
                    rows.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    tbody.innerHTML = rows.map(row =>
                        `<tr>
                            <td>${row.collector}</td>
                            <td>${row.timestamp}</td>
                            <td><span class="badge" style="background:${statusColors[row.status] || '#6c757d'};color:#fff;">${row.status}</span></td>
                            <td>${row.message || ''}</td>
                        </tr>`
                    ).join('');
                });
        }
        // Time range selector event
        if (document.getElementById('historyRange')) {
            document.getElementById('historyRange').addEventListener('change', updateHistory);
        }

        // Fetch and update logs with filters
        function updateLogs() {
            const collector = document.getElementById('logCollector').value;
            const level = document.getElementById('logLevel').value;
            const hours = document.getElementById('logHours').value;
            
            let url = `/api/logs?hours=${hours}`;
            if (collector) url += `&collector=${collector}`;
            if (level) url += `&level=${level}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('logContainer');
                    container.innerHTML = data.map(log => `
                        <div class="log-entry log-${log.level.toLowerCase()}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${new Date(log.timestamp).toLocaleString()}</strong>
                                    <span class="badge bg-${log.level === 'ERROR' ? 'danger' : 
                                                       log.level === 'WARNING' ? 'warning' : 
                                                       'info'} ms-2">${log.level}</span>
                                    <span class="badge bg-secondary ms-2">${log.collector}</span>
                                    ${log.task_type ? `<span class="badge bg-info ms-2">${log.task_type}</span>` : ''}
                                </div>
                                ${log.is_heartbeat ? '<span class="badge bg-success">Heartbeat</span>' : ''}
                            </div>
                            <div class="mt-1">${log.message}</div>
                            ${log.details ? `
                                <div class="mt-1">
                                    <small class="text-muted">Details:</small>
                                    <pre class="mb-0">${JSON.stringify(log.details, null, 2)}</pre>
                                </div>
                            ` : ''}
                            ${log.error_details ? `
                                <div class="mt-1">
                                    <small class="text-muted">Error Details:</small>
                                    <pre class="mb-0">${JSON.stringify(log.error_details, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                });
        }

        // Add event listeners for log filters
        document.getElementById('logCollector').addEventListener('change', updateLogs);
        document.getElementById('logLevel').addEventListener('change', updateLogs);
        document.getElementById('logHours').addEventListener('change', updateLogs);
        document.getElementById('refreshLogs').addEventListener('click', updateLogs);

        // Fetch and update data freshness
        function updateDataFreshness() {
            fetch('/api/data_freshness')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('dataFreshnessContainer');
                    let html = '';
                    
                    Object.entries(data).forEach(([collector, info]) => {
                        const freshnessClass = info.status === 'up_to_date' ? 'fresh' : 
                                             info.status === 'stale' ? 'stale' : 'warning';
                        const completenessClass = info.completeness >= 90 ? '' : 
                                                info.completeness >= 70 ? 'warning' : 'danger';
                        
                        html += `
                            <div class="card data-freshness-card ${freshnessClass} mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h6 class="mb-2">${collector.charAt(0).toUpperCase() + collector.slice(1)} Collector</h6>
                                            <span class="badge bg-${info.status === 'up_to_date' ? 'success' : 'danger'}">
                                                ${info.status.replace('_', ' ')}
                                            </span>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Last Data Timestamp</small>
                                            <span class="timestamp-tooltip" title="Europe/Copenhagen (CEST) timezone">
                                                ${info.last_data_timestamp ? new Date(info.last_data_timestamp).toLocaleString() : 'N/A'}
                                            </span>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Items Collected (Last Hour)</small>
                                            <strong>${info.items_collected}</strong> / ${info.expected_items}
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Completeness</small>
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="completeness-bar">
                                                        <div class="completeness-bar-fill ${completenessClass}" 
                                                             style="width: ${info.completeness}%"></div>
                                                    </div>
                                                </div>
                                                <span class="ms-2">${info.completeness}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    
                    container.innerHTML = html;
                });
        }

        // Fetch and update collection counts chart
        function updateCollectionCountsChart(view) {
            fetch(`/api/collection_counts?view=${view}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Collection counts data:', data); // Debug print
                    const ctx = document.getElementById('collectionCountsChart').getContext('2d');
                    
                    // Process data
                    const newsData = {};
                    const darkpoolData = {};
                    let totalNews = 0;
                    let totalDarkpool = 0;
                    
                    data.forEach(item => {
                        const interval = item.interval;
                        if (!interval) return; // skip invalid/null
                        if (item.collector === 'news') {
                            newsData[interval] = item.count;
                            totalNews += item.count;
                        } else if (item.collector === 'darkpool') {
                            darkpoolData[interval] = item.count;
                            totalDarkpool += item.count;
                        }
                    });
                    
                    // Get all unique intervals, filter out invalids
                    const allIntervals = [...new Set([...Object.keys(newsData), ...Object.keys(darkpoolData)])]
                        .filter(i => !!i)
                        .sort();
                    
                    // Prepare labels, handle invalid dates
                    const labels = allIntervals.map(i => {
                        const d = new Date(i);
                        if (isNaN(d)) {
                            console.warn('Invalid interval for chart label:', i);
                            return '';
                        }
                        return d.toLocaleString();
                    });
                    
                    // Prepare data for chart
                    const newsCounts = allIntervals.map(interval => newsData[interval] || 0);
                    const darkpoolCounts = allIntervals.map(interval => darkpoolData[interval] || 0);
                    
                    // Update summary statistics
                    document.getElementById('totalNewsCount').textContent = totalNews;
                    document.getElementById('totalDarkpoolCount').textContent = totalDarkpool;
                    document.getElementById('avgNewsCount').textContent = 
                        Math.round(totalNews / allIntervals.length);
                    document.getElementById('avgDarkpoolCount').textContent = 
                        Math.round(totalDarkpool / allIntervals.length);
                    
                    const chartData = {
                        labels: labels,
                        datasets: [
                            {
                                label: 'News Collector',
                                data: newsCounts,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Darkpool Collector',
                                data: darkpoolCounts,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    };
                    
                    // Always destroy and re-create the chart
                    if (window.collectionCountsChart && typeof window.collectionCountsChart.destroy === 'function') {
                        window.collectionCountsChart.destroy();
                    }
                    window.collectionCountsChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw} items`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Items Collected'
                                    }
                                }
                            }
                        }
                    });
                });
        }

        // Export form handler
        document.getElementById('exportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const collectors = Array.from(form.querySelectorAll('input[name="collectors"]:checked')).map(cb => cb.value).join(',');
            const startTime = form.start_time.value ? new Date(form.start_time.value).toISOString() : '';
            const endTime = form.end_time.value ? new Date(form.end_time.value).toISOString() : '';
            let url = `/api/export?collectors=${collectors}`;
            if (startTime) url += `&start_time=${encodeURIComponent(startTime)}`;
            if (endTime) url += `&end_time=${encodeURIComponent(endTime)}`;
            window.open(url, '_blank');
        });

        // Chart view toggle handlers
        document.querySelectorAll('[data-chart-view]').forEach(button => {
            button.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('[data-chart-view]').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                // Update chart view
                const view = this.dataset.chartView;
                updateCollectionCountsChart(view);
            });
        });

        // Initial load
        updateStatus();
        updateHistory();
        updateLogs();
        updateDataFreshness();
        updateCollectionCountsChart('hourly');

        // Set up periodic updates
        setInterval(updateStatus, 30000);  // Every 30 seconds
        setInterval(updateHistory, 300000);  // Every 5 minutes
        setInterval(updateLogs, 60000);  // Every minute
        setInterval(updateDataFreshness, 30000);  // Every 30 seconds
        setInterval(updateCollectionCountsChart, 300000);  // Every 5 minutes

        // Manual Controls Functions
        function showBackfillModal(collector) {
            document.getElementById('backfillCollector').value = collector;
            new bootstrap.Modal(document.getElementById('backfillModal')).show();
        }
        
        function triggerBackfill() {
            const collector = document.getElementById('backfillCollector').value;
            const hours = document.getElementById('backfillHours').value;
            
            fetch('/api/backfill', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    collector: collector,
                    hours: parseInt(hours)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Backfill started successfully');
                    bootstrap.Modal.getInstance(document.getElementById('backfillModal')).hide();
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
        
        function restartCollector(collector) {
            if (!confirm(`Are you sure you want to restart the ${collector} collector?`)) {
                return;
            }
            
            fetch('/api/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    collector: collector
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Restart triggered successfully');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 